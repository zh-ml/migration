name: GIT-SYNC

on:
  push:
    branches:
      - feature/*
  pull_request:
    types: [ opened ]
    branches:
      - feature/*

jobs:
  syncGHtoGHE:
    runs-on: ubuntu-latest
    environment:
      name: PAT
    timeout-minutes: 15
    steps:
      - name: git-sync
        if: github.server_url == 'https://github.com'
        uses: wei/git-sync@v3
        with:
          # source_repo: "https://zhang-m:${{ secrets.PAT }}@github.jp.klab.com/zhang-m/migration-test.git"
          source_repo: "zh-ml/migration"
          source_branch: "$GITHUB_REF"
          # destination_repo: "zh-ml/migration"
          destination_repo: "https://zhang-m:${{ secrets.PAT }}@github.jp.klab.com/zhang-m/migration-test.git"
          destination_branch: "$GITHUB_REF"
          ssh_private_key: ${{ secrets.SSH_PRIVATE_KEY }} # optional
          # source_ssh_private_key: ${{ secrets.SSH_PRIVATE_KEY }} # optional, will override `SSH_PRIVATE_KEY`
          # destination_ssh_private_key: ${{ secrets.SSH_PRIVATE_KEY }} # optional, will override `SSH_PRIVATE_KEY`
  
  action:
    runs-on: ubuntu-latest
    environment:
      name: PAT
    timeout-minutes: 15
    steps:
      - name: Set variables
        if: github.server_url == 'https://github.com'
        run: |
          echo 'PR_BODY<<EOF' >> $GITHUB_ENV
          echo "the same as #${{ github.event.pull_request.number }}" >> $GITHUB_ENV
          echo "" >> $GITHUB_ENV
          echo "---" >> $GITHUB_ENV
          echo "" >> $GITHUB_ENV
          echo "${{ github.event.pull_request.body }}" >> $GITHUB_ENV
          echo 'EOF' >> $GITHUB_ENV
      - name: pull-request
        uses: repo-sync/pull-request@v2
        with:
          source_branch: "${{ github.event.pull_request.head.ref }}"
          destination_branch: main
          github_token: ${{ secrets.SELF_GITHUB_TOKEN1 }}
          pr_label: beta
          pr_title: "${{ github.event.pull_request.title }}"
          pr_body : |
            ${{ env.PR_BODY }}